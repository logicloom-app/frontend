"use client";

import {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { Pencil } from "lucide-react";
import Spinner from "@/components/ui/Spinner";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Button } from "@/components/ui/button";
import { useToast } from "@/lib/hooks/use-toast";
import { updateWebsitePackage } from "@/services/adminServices";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { useFormik } from "formik";
import * as Yup from "yup";
import { useState } from "react";
import { X, Plus } from "lucide-react";

const EditPackageSchema = Yup.object().shape({
  name: Yup.string().required("Name is required"),
  slug: Yup.string().required("Slug is required"),
  description: Yup.string().required("Description is required"),
  original_price: Yup.number()
    .typeError("Original price must be a number")
    .required("Original price is required")
    .min(0, "Price must be positive"),
  discounted_price: Yup.number()
    .typeError("Discounted price must be a number")
    .required("Discounted price is required")
    .min(0, "Price must be positive"),
  badge: Yup.string(),
  features: Yup.array().of(Yup.string()).min(1, "At least one feature is required"),
});

export default function EditWebsitePackage({ pkg }) {
  const queryClient = useQueryClient();
  const { toast } = useToast();
  const [featureInput, setFeatureInput] = useState("");

  const { isLoading: isEditing, mutateAsync: mutateEditPackage } = useMutation({
    mutationFn: updateWebsitePackage,
    onSuccess: (data) => {
      toast({
        description: "Website package updated successfully",
        className: "rounded-2xl",
      });
      queryClient.invalidateQueries({ queryKey: ["get-website-packages"] });
    },
    onError: (error) => {
      toast({
        variant: "destructive",
        description: error?.response?.data?.error || "Something went wrong",
        className: "rounded-2xl",
      });
    },
  });

  const editHandler = async (values) => {
    const data = {
      id: pkg?.id,
      name: values?.name,
      slug: values?.slug,
      description: values?.description,
      original_price: values?.original_price,
      discounted_price: values?.discounted_price,
      features: values?.features,
      badge: values?.badge || "",
      created_at: pkg?.created_at,
      updated_at: pkg?.updated_at,
    };

    await mutateEditPackage(data);
  };

  const packageFormik = useFormik({
    initialValues: {
      name: pkg?.name || "",
      slug: pkg?.slug || "",
      description: pkg?.description || "",
      original_price: pkg?.original_price || "",
      discounted_price: pkg?.discounted_price || "",
      badge: pkg?.badge || "",
      features: pkg?.features || [],
    },
    validationSchema: EditPackageSchema,
    enableReinitialize: true,
    validateOnMount: true,
    onSubmit: editHandler,
  });

  const handleAddFeature = () => {
    if (featureInput.trim()) {
      packageFormik.setFieldValue("features", [
        ...packageFormik.values.features,
        featureInput.trim(),
      ]);
      setFeatureInput("");
    }
  };

  const handleRemoveFeature = (index) => {
    const newFeatures = packageFormik.values.features.filter((_, i) => i !== index);
    packageFormik.setFieldValue("features", newFeatures);
  };

  return (
    <Dialog>
      <DialogTrigger className="rounded-full">
        <div className="p-2 rounded-full dark:text-blue-400 hover:bg-gray-100 dark:hover:bg-blue-400/20 transition duration-300">
          <Pencil />
        </div>
      </DialogTrigger>

      <DialogContent className="sm:rounded-3xl max-w-[700px] max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="mb-1">Edit Website Package</DialogTitle>
          <DialogDescription className="text-sm text-gray-500 dark:text-gray-400">
            Update package information and pricing
          </DialogDescription>
        </DialogHeader>

        <form onSubmit={packageFormik.handleSubmit} className="flex flex-col gap-5">
          {/* Name */}
          <div>
            <Input
              type="text"
              id="name"
              name="name"
              placeholder="Package Name"
              className="rounded-2xl px-4 py-2"
              value={packageFormik.values.name}
              onChange={packageFormik.handleChange}
              onBlur={packageFormik.handleBlur}
            />
            {packageFormik.touched.name && packageFormik.errors.name ? (
              <div className="ml-2 mt-1 text-rose-500 text-left text-xs">
                {packageFormik.errors.name}
              </div>
            ) : null}
          </div>

          {/* Slug */}
          <div>
            <Input
              type="text"
              id="slug"
              name="slug"
              placeholder="Slug (e.g., one-page-website)"
              className="rounded-2xl px-4 py-2"
              value={packageFormik.values.slug}
              onChange={packageFormik.handleChange}
              onBlur={packageFormik.handleBlur}
            />
            {packageFormik.touched.slug && packageFormik.errors.slug ? (
              <div className="ml-2 mt-1 text-rose-500 text-left text-xs">
                {packageFormik.errors.slug}
              </div>
            ) : null}
          </div>

          {/* Description */}
          <div>
            <Textarea
              id="description"
              name="description"
              placeholder="Description"
              className="rounded-2xl px-4 py-2"
              rows={3}
              value={packageFormik.values.description}
              onChange={packageFormik.handleChange}
              onBlur={packageFormik.handleBlur}
            />
            {packageFormik.touched.description &&
            packageFormik.errors.description ? (
              <div className="ml-2 mt-1 text-rose-500 text-left text-xs">
                {packageFormik.errors.description}
              </div>
            ) : null}
          </div>

          {/* Prices */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <Input
                type="number"
                id="original_price"
                name="original_price"
                placeholder="Original Price"
                className="rounded-2xl px-4 py-2"
                value={packageFormik.values.original_price}
                onChange={packageFormik.handleChange}
                onBlur={packageFormik.handleBlur}
              />
              {packageFormik.touched.original_price &&
              packageFormik.errors.original_price ? (
                <div className="ml-2 mt-1 text-rose-500 text-left text-xs">
                  {packageFormik.errors.original_price}
                </div>
              ) : null}
            </div>

            <div>
              <Input
                type="number"
                id="discounted_price"
                name="discounted_price"
                placeholder="Discounted Price"
                className="rounded-2xl px-4 py-2"
                value={packageFormik.values.discounted_price}
                onChange={packageFormik.handleChange}
                onBlur={packageFormik.handleBlur}
              />
              {packageFormik.touched.discounted_price &&
              packageFormik.errors.discounted_price ? (
                <div className="ml-2 mt-1 text-rose-500 text-left text-xs">
                  {packageFormik.errors.discounted_price}
                </div>
              ) : null}
            </div>
          </div>

          {/* Badge */}
          <div>
            <Input
              type="text"
              id="badge"
              name="badge"
              placeholder="Badge (e.g., Popular, Premium)"
              className="rounded-2xl px-4 py-2"
              value={packageFormik.values.badge}
              onChange={packageFormik.handleChange}
              onBlur={packageFormik.handleBlur}
            />
          </div>

          {/* Features */}
          <div>
            <label className="text-sm font-medium mb-2 block">Features</label>
            <div className="flex gap-2 mb-2">
              <Input
                type="text"
                placeholder="Add a feature"
                className="rounded-2xl px-4 py-2 flex-1"
                value={featureInput}
                onChange={(e) => setFeatureInput(e.target.value)}
                onKeyPress={(e) => {
                  if (e.key === "Enter") {
                    e.preventDefault();
                    handleAddFeature();
                  }
                }}
              />
              <Button
                type="button"
                onClick={handleAddFeature}
                className="rounded-2xl px-4"
                variant="outline"
              >
                <Plus className="w-4 h-4" />
              </Button>
            </div>
            <div className="space-y-2 max-h-32 overflow-y-auto">
              {packageFormik.values.features.map((feature, index) => (
                <div
                  key={index}
                  className="flex items-center justify-between bg-gray-100 dark:bg-gray-800 rounded-xl px-3 py-2"
                >
                  <span className="text-sm">{feature}</span>
                  <button
                    type="button"
                    onClick={() => handleRemoveFeature(index)}
                    className="text-rose-500 hover:text-rose-700"
                  >
                    <X className="w-4 h-4" />
                  </button>
                </div>
              ))}
            </div>
            {packageFormik.touched.features && packageFormik.errors.features ? (
              <div className="ml-2 mt-1 text-rose-500 text-left text-xs">
                {packageFormik.errors.features}
              </div>
            ) : null}
          </div>

          <Button className="w-full rounded-2xl" type="submit" disabled={isEditing}>
            {isEditing ? <Spinner className="w-6 h-6" /> : "Update Package"}
          </Button>
        </form>
      </DialogContent>
    </Dialog>
  );
}
